{"changed":true,"filter":false,"title":"index.js","tooltip":"/index.js","value":"// \n// # SimpleServer\n//\n// A simple chat server using Socket.IO, Express, and Async.\n//\n\nvar http = require('http');\nvar path = require('path');\n\nvar async = require('async');\nvar socketio = require('socket.io');\nvar express = require('express');\n\n//\n// ## SimpleServer `SimpleServer(obj)`\n//\n// Creates a new instance of SimpleServer with the following options:\n//  * `port` - The HTTP port to listen on. If `process.env.PORT` is set, _it overrides this value_.\n//\nvar router = express();\nvar server = http.createServer(router);\nvar io = socketio.listen(server);\n\nrouter.configure(function (){ //Redireciona as conexões para o diretorio client\n  router.use(\n      \"/\",\n      express.static(path.resolve(__dirname, \"client\"))\n    );\n});\n\nvar sockets = [];\nvar roles = [];\nvar beforestart = 0;\n\nio.on('connection', function (socket) { //Estabelece os callbacks de cada event  ('event', callback (funçao executada quando recebe aquele evento.))\n\n    sockets.push(socket);\n\n    socket.on('disconnect', function () {\n      sockets.splice(sockets.indexOf(socket), 1);\n      updateRoster();\n    });\n\n    socket.on('startgame', function() {\n      beforestart = 0;\n      randomRoles(3, 1, 1, 1, 1, 1, 2);\n    });\n    \n    socket.on('identify', function (name) {\n      if (name == '') {\n        name = 'Anonymous';\n      }\n      var nickname = (sockets.indexOf(socket) + 1) + '. '+name;\n      \n      socket.set('role', 'none');\n      \n      socket.set('name', nickname, function (err) {\n        updateRoster();\n      });\n    });\n  });\n\nfunction updateRoster() {\n  async.map(  //Evento assíncrono que, para cada elemento do array, executa uma função esperando resultados,\n    sockets, // depois, cria um array com todos resultados e chama a última função. O interessante é que\n    function (socket, callback) { // socket.get também é assíncrono, então ele só chama a próxima função\n      socket.get('name', callback); // depois que voltar o resultado do get.\n    },\n    function (err, names) {\n      broadcast('roster', names); //broadcast nos jogadores\n    }\n  );\n  \n  async.map(\n    sockets,\n    function(socket, callback) {\n      socket.get('role', callback);\n    }, \n    function (err, names) {\n      sockets.forEach(function (socket){\n        names.forEach(function (name){\n          if(sockets.indexOf(socket) == names.indexOf(name)){\n            roles[sockets.indexOf(socket)] = name;\n            socket.emit('tellrole', name);  //emit individual na role\n          }\n        })\n      });\n    });\n}\n\nfunction broadcast(event, data) {\n  sockets.forEach(function (socket) {\n    socket.emit(event, data);\n  });\n}\n\nserver.listen(process.env.PORT || 3000, process.env.IP || \"0.0.0.0\", function(){\n  var addr = server.address();\n  console.log(\"Chat server listening at\", addr.address + \":\" + addr.port);\n});\n\n/* ***************************** GAME ******************************************\n******************************** FUNCTIONS *************************************\n*/\n\nfunction randomRoles( werewolfnumber, witchnumber, cupidnumber, hunternumber, littlegirlnumber, seernumber, villagernumber) {\n  sockets.forEach(function (socket){\n    var role = 'none';\n    while(role == 'none'){\n      var numb = Math.floor(Math.random()*7) + 1;\n      switch(numb){\n        case 1:\n          if(werewolfnumber!=0){\n            werewolfnumber--;\n            role = 'werewolf';\n            socket.set('role', 'werewolf');\n          }\n          break;\n        case 2:\n          if(witchnumber!=0){\n            witchnumber--;\n            role = 'witch';\n            socket.set('role', 'witch');\n          }\n          break;\n        case 3:\n          if(cupidnumber!=0){\n            cupidnumber--;\n            role = 'cupid';\n            socket.set('role', 'cupid');\n          }\n          break;\n        case 4:\n          if(littlegirlnumber!=0){\n            littlegirlnumber--;\n            role = 'littlegirl';\n            socket.set('role', 'littlegirl');\n          }\n          break;\n        case 5:\n          if(hunternumber!=0){\n            hunternumber--;\n            role = 'hunter';\n            socket.set('role', 'hunter');\n          }\n          break;\n        case 6:\n          if(seernumber!=0){\n            seernumber--;\n            role = 'seer';\n            socket.set('role', 'seer');\n          }\n          break;\n        case 7:\n          if(villagernumber!=0){\n            villagernumber--;\n            role = 'villager';\n            socket.set('role', 'villager');\n          }\n          break;\n      }\n    }\n  startGame();\n  });\n}\n\nfunction startGame(){\n  updateRoster();\n  beforestart++; //Como randomroles dá um startgame para cada socket, espera todos receberem startgame para\n  if(beforestart == sockets.length){ // de fato dar broadcast no start.\n    broadcast('startgame', null);\n    startNightCycle();\n  } \n}\n\nfunction startNightCycle(){\n  newTurn('werewolf', 30);\n}\n\nfunction newTurn(role, time){\n  sockets.forEach(function (socket){\n    if(roles[sockets.indexOf(socket)] == role){\n      socket.emit('startclock', time);\n    }\n  });\n}\n\n/* TODO:\n *   Ao startar o jogo, quando tem muitos jogadores, alguns não recebem o startgame, pode ser\n *   problema ao dar muitos emits, já que ele dá um updateroster pra cada um... talvez utilizar\n *  async.map no randomroles resolva.git\n*/","undoManager":{"mark":97,"position":100,"stack":[[{"group":"doc","deltas":[{"start":{"row":189,"column":55},"end":{"row":189,"column":56},"action":"remove","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":54},"end":{"row":189,"column":55},"action":"remove","lines":["p"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":53},"end":{"row":189,"column":54},"action":"remove","lines":["m"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":53},"end":{"row":189,"column":54},"action":"insert","lines":["p"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":54},"end":{"row":189,"column":55},"action":"insert","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":55},"end":{"row":189,"column":56},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":56},"end":{"row":189,"column":57},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":57},"end":{"row":189,"column":58},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":58},"end":{"row":189,"column":59},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":59},"end":{"row":189,"column":60},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":60},"end":{"row":189,"column":61},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":61},"end":{"row":189,"column":62},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":62},"end":{"row":189,"column":63},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":63},"end":{"row":189,"column":64},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":64},"end":{"row":189,"column":65},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":65},"end":{"row":189,"column":66},"action":"insert","lines":["p"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":66},"end":{"row":189,"column":67},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":67},"end":{"row":189,"column":68},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":68},"end":{"row":189,"column":69},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":69},"end":{"row":189,"column":70},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":70},"end":{"row":189,"column":71},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":71},"end":{"row":189,"column":72},"action":"insert","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":72},"end":{"row":189,"column":73},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":73},"end":{"row":189,"column":74},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":74},"end":{"row":189,"column":75},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":75},"end":{"row":189,"column":76},"action":"insert","lines":["m"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":76},"end":{"row":189,"column":77},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":77},"end":{"row":189,"column":78},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":78},"end":{"row":189,"column":79},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":79},"end":{"row":189,"column":80},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":80},"end":{"row":189,"column":81},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":81},"end":{"row":189,"column":82},"action":"insert","lines":["ã"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":81},"end":{"row":189,"column":82},"action":"remove","lines":["ã"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":80},"end":{"row":189,"column":81},"action":"remove","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":80},"end":{"row":189,"column":81},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":81},"end":{"row":189,"column":82},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":82},"end":{"row":189,"column":83},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":83},"end":{"row":189,"column":84},"action":"insert","lines":["v"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":84},"end":{"row":189,"column":85},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":85},"end":{"row":189,"column":86},"action":"insert","lines":["z"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":86},"end":{"row":189,"column":87},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":87},"end":{"row":189,"column":88},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":88},"end":{"row":189,"column":89},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":89},"end":{"row":189,"column":90},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":90},"end":{"row":189,"column":91},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":91},"end":{"row":189,"column":92},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":92},"end":{"row":189,"column":93},"action":"insert","lines":["z"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":93},"end":{"row":189,"column":94},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":94},"end":{"row":189,"column":95},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":95},"end":{"row":190,"column":0},"action":"insert","lines":["",""]},{"start":{"row":190,"column":0},"end":{"row":190,"column":1},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":1},"end":{"row":190,"column":2},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":2},"end":{"row":190,"column":3},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":3},"end":{"row":190,"column":4},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":4},"end":{"row":190,"column":5},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":5},"end":{"row":190,"column":6},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":6},"end":{"row":190,"column":7},"action":"insert","lines":["y"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":7},"end":{"row":190,"column":8},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":8},"end":{"row":190,"column":9},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":9},"end":{"row":190,"column":10},"action":"insert","lines":[","]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":10},"end":{"row":190,"column":11},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":10},"end":{"row":190,"column":11},"action":"remove","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":9},"end":{"row":190,"column":10},"action":"remove","lines":[","]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":9},"end":{"row":190,"column":10},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":10},"end":{"row":190,"column":11},"action":"insert","lines":["m"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":11},"end":{"row":190,"column":12},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":12},"end":{"row":190,"column":13},"action":"insert","lines":["p"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":13},"end":{"row":190,"column":14},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":14},"end":{"row":190,"column":15},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":15},"end":{"row":190,"column":16},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":16},"end":{"row":190,"column":17},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":17},"end":{"row":190,"column":18},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":18},"end":{"row":190,"column":19},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":19},"end":{"row":190,"column":20},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":20},"end":{"row":190,"column":21},"action":"insert","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":21},"end":{"row":190,"column":22},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":22},"end":{"row":190,"column":23},"action":"insert","lines":["m"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":23},"end":{"row":190,"column":24},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":23},"end":{"row":190,"column":24},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":23},"end":{"row":190,"column":24},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":24},"end":{"row":190,"column":25},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":25},"end":{"row":190,"column":26},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":26},"end":{"row":190,"column":27},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":27},"end":{"row":190,"column":28},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":28},"end":{"row":190,"column":29},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":28},"end":{"row":190,"column":29},"action":"remove","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":27},"end":{"row":190,"column":28},"action":"remove","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":27},"end":{"row":190,"column":28},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":28},"end":{"row":190,"column":29},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":29},"end":{"row":190,"column":30},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":30},"end":{"row":190,"column":31},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":31},"end":{"row":190,"column":32},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":32},"end":{"row":190,"column":33},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":33},"end":{"row":190,"column":34},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":34},"end":{"row":190,"column":35},"action":"insert","lines":["v"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":35},"end":{"row":190,"column":36},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":36},"end":{"row":190,"column":37},"action":"insert","lines":[","]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":36},"end":{"row":190,"column":37},"action":"remove","lines":[","]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":36},"end":{"row":190,"column":37},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":37},"end":{"row":190,"column":38},"action":"insert","lines":["g"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":38},"end":{"row":190,"column":39},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":39},"end":{"row":190,"column":40},"action":"insert","lines":["t"]}]}]]},"ace":{"folds":[],"scrolltop":2458.5,"scrollleft":0,"selection":{"start":{"row":190,"column":40},"end":{"row":190,"column":40},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":174,"state":"no_regex","mode":"ace/mode/javascript"}},"timestamp":1424869554775}